import os
import sys
import hashlib
from Crypto import Random
from Crypto.Cipher import AES

def pad(s):
    return s + b"\0" * (AES.block_size - len(s) % AES.block_size)

def encrypt_file(key, passwd_list):
    message = ""
    for passwd in passwd_list:
        message += passwd + '\n'

    message = pad(message)
    iv = Random.new().read(AES.block_size)
    cipher = AES.new(key, AES.MODE_CBC, iv)
    ciphertext = iv + cipher.encrypt(message)
    with open('passwd_file', 'w') as f:
        f.write(ciphertext)

def decrypt_file(key):
    file = open('passwd_file', 'r')
    ciphertext = file.read()
    iv = ciphertext[:AES.block_size]
    cipher = AES.new(key, AES.MODE_CBC, iv)
    plaintext = cipher.decrypt(ciphertext[AES.block_size:])
    plaintext = plaintext.rstrip(b"\0")
    passwd_list = plaintext.split('\n')
    return passwd_list


def new_user():
    print "Welcome to the Password Manager!"

    while True:
        passwd = raw_input('Please enter a new password: ')
        passwd_check = raw_input('Reenter password: ')
        if passwd != passwd_check:
            print '[-] Passwords do not match! Please reenter you password.'
            continue
        else:
            break

    hash = hashlib.sha256(passwd).hexdigest()
    passwd_list = [hash]
    encrypt_file(hash[:32], passwd_list)
    print '[+] Password created!'
    return hash


def main():
    if not os.path.isfile('passwd_file'):
        AES_pass = new_user()
        passwd_list = decrypt_file(AES_pass[:32])
    else:
        print "Welcome to the Password Manager!"
        passwd = raw_input("Enter your password: ")
        AES_pass = hashlib.sha256(passwd).hexdigest()
        passwd_list = decrypt_file(AES_pass[:32])

    if AES_pass != passwd_list[0]:
        print '[-] Wrong password!'
        sys.exit(0)

    print 'Placeholder'

if __name__ == '__main__':
	main()
